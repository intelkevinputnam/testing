<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2020" />
<meta name="DC.rights.owner" content="(C) Copyright 2020" />
<meta name="DC.type" content="topic" />
<meta name="DC.title" content="Step 2: Prepare a Yocto Project*-Based Image" />
<meta name="DC.coverage" content="" />
<meta name="DC.format" content="XHTML" />
<meta name="DC.identifier" content="step-2-prepare-a-yocto-project-based-image" />
<meta name="DC.language" content="en-US" />
<link rel="stylesheet" type="text/css" href="../commonltr.css" />
<title>Step 2: Prepare a Yocto Project*-Based Image</title>
</head>
<body class="no-rel-links" id="step-2-prepare-a-yocto-project-based-image">

    <h1 class="title topictitle1" id="ariaid-title1">Step 2: Prepare a Yocto Project*-Based Image</h1>

    <div class="body">
        <div class="div" id="step-2-prepare-a-yocto-project-based-image__build-yocto-image-toolchain"></div>
        <div class="div" id="step-2-prepare-a-yocto-project-based-image__step-2-prepare-a-yocto-project-based-image">
            <p class="p">In this step, you will build a Yocto Project*-based image for the target system, and you will build the associated toolchain for the host system.</p>

            <ul class="ul">
                <li class="li">
                    <p class="p"><strong class="ph b">Image:</strong> You will start by building an image using the platform board support package (BSP) and integrate the Intel® Time Coordinated Computing Tools (Intel® TCC Tools) layer into it. The custom image provides full support for Intel® TCC Tools, making it the recommended approach to start with. In addition, you can choose to add the Intel® VTune™ Profiler layer to your image to experience the full capabilities of Intel® VTune™ Profiler when profiling applications on your target system.</p>

                    <p class="p"><em class="ph i">Alternative to this image:</em> An alternative to building this image for the target is to install all dependencies on the default BSP image for Yocto Project and then deploying Intel® TCC Tools there. The <a class="xref" href="https://software.intel.com/content/www/us/en/secure/develop/documentation/intel-time-coordinated-computing-tools-developer-guide-0-11/top/prerequisites-and-installation.html" target="_blank">Developer Guide</a> offers a list of dependencies to resolve and steps for deploying Intel® TCC Tools on an already prepared OS.</p>

                </li>

                <li class="li">
                    <p class="p"><strong class="ph b">Toolchain:</strong> This step also shows how to build the recommended toolchain for development. The toolchain enables you to cross-compile for the target Yocto Project-based OS and resolves all build time dependencies.</p>

                    <p class="p"><em class="ph i">Alternative to this toolchain:</em> An alternative to using the toolchain is to set up your host environment manually, by installing build dependencies. For instructions, see <a class="xref" href="https://software.intel.com/content/www/us/en/secure/develop/documentation/intel-time-coordinated-computing-tools-developer-guide-0-11/top/prerequisites-and-installation.html" target="_blank">Developer Guide</a>.</p>

                </li>

            </ul>

            <div class="note note"><span class="notetitle">Note:</span> 
                <p class="p">Your system will take anywhere from one half-hour (assuming your system is a large server) to several hours (assuming your system is a typical laptop).</p>

            </div>

            <p class="p">To build a Yocto Project*-based image and toolchain:</p>

            <ol class="ol">
                <li class="li">
                    <p class="p">Install the build host packages on your host system.
                    This is a one-time step.</p>

                    <p class="p">The following command is for Ubuntu* 20.04 LTS. For updates
                    and other supported Linux* distributions, see <a class="xref" href="https://www.yoctoproject.org/docs/current/ref-manual/ref-manual.html#required-packages-for-the-build-host" target="_blank">Yocto Project Reference
                    Manual</a>.</p>

                    <pre class="pre codeblock"><code>
$ sudo apt-get install gawk wget git-core diffstat unzip texinfo gcc-multilib \
                        build-essential chrpath socat cpio python3 python3-pip python3-pexpect \
                        xz-utils debianutils iputils-ping python3-git python3-jinja2 libegl1-mesa libsdl1.2-dev \
                        pylint3 xterm python curl git-lfs                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Download the BSP image sources for the
                    target platform and finish the setup steps in the release notes (all steps before calling the “bitbake” command in the “Build the Yocto Project*-based Image” section).</p>

                    <div class="note note"><span class="notetitle">Note:</span> 
                        <p class="p">The optional step for bmaptool integration is required if you are going to boot the image from the internal local drive on the target system.</p>

                    </div>

                    <p class="p">See the appropriate release notes:</p>

                    <ul class="ul">
                        <li class="li">
                            <p class="p"><a class="xref" href="https://cdrdv2.intel.com/v1/dl/getContent/615079" target="_blank">Tiger Lake UP3 BSP release
                            notes</a></p>

                            <div class="note note"><span class="notetitle">Note:</span> 
                                <p class="p">The steps for including proprietary package RTCM are necessary.</p>

                            </div>

                        </li>

                        <li class="li">
                            <p class="p"><a class="xref" href="https://cdrdv2.intel.com/v1/dl/getContent/616424" target="_blank">Elkhart Lake BSP release
                            notes</a></p>

                        </li>

                    </ul>

                </li>

                <li class="li">
                    <p class="p"><strong class="ph b">For Tiger Lake Beta 2 BSP only:</strong></p>

                    <ol class="ol" type="a">
                        <li class="li">
                            <p class="p">Patch the tcc_buffer driver:</p>

                            <ol class="ol" type="i">
                                <li class="li">
                                    <p class="p">Go to the kernel folder:</p>

                                    <pre class="pre codeblock"><code>
cd /&lt;BSP_directory&gt;/managed/linux-intel-ese-lts-5.4                                    </code></pre>
                                </li>

                                <li class="li">
                                    <p class="p">Create a branch:</p>

                                    <pre class="pre codeblock"><code>
git checkout -b DRIVER_PATCH                                    </code></pre>
                                </li>

                                <li class="li">
                                    <p class="p">Apply the patch from the install directory
                                    in <a class="xref" href="tcc_gsg_download.html#download-tcc-tools">Step 1: Download and Install the Package</a>:</p>

                                    <pre class="pre codeblock"><code>
git am &lt;install_directory&gt;/target/meta-intel-tcc/recipes-kernel/linux/0001-tcc-tcc-driver-should-not-exit-even-if-no-psram-entry.patch                                    </code></pre>
                                </li>

                            </ol>

                        </li>

                        <li class="li">
                            <p class="p">Disable <code class="ph codeph">resctrl</code>:</p>

                            <p class="p">Linux kernel Resource Control (<code class="ph codeph">resctrl</code>) controls <a class="xref" href="https://www.kernel.org/doc/Documentation/x86/intel_rdt_ui.txt" target="_blank">Intel® Resource Director Technology and Cache Allocation Technology</a>.</p>

                            <p class="p">However, <code class="ph codeph">resctrl</code> overrides configurations done by the cache configurator. Intel recommends disabling <code class="ph codeph">resctrl</code> for Tiger Lake UP3.</p>

                            <ol class="ol" type="i">
                                <li class="li">
                                    <p class="p">Open <code class="ph codeph">local.conf</code>. The following command uses vi as an example.
                                    Feel free to use any method.</p>

                                    <pre class="pre codeblock"><code>
vi /&lt;BSP_directory&gt;/build/conf/local.conf                                    </code></pre>
                                </li>

                                <li class="li">
                                    <p class="p">Add the following text at the end of the file:</p>

                                    <pre class="pre codeblock"><code>
APPEND += " rdt=!l3cat,!l2cat"                                    </code></pre>
                                </li>

                                <li class="li">
                                    <p class="p">Save your changes and exit the file.</p>

                                </li>

                            </ol>

                        </li>

                    </ol>

                </li>

                <li class="li">
                    <p class="p">Go to the install directory in <a class="xref" href="tcc_gsg_download.html#download-tcc-tools">Step 1: Download and Install the Package</a>:</p>

                    <pre class="pre codeblock"><code>
cd &lt;install_directory&gt;                    </code></pre>
                    <div class="note note"><span class="notetitle">Note:</span> 
                        <p class="p">You may integrate Intel® VTune™ Profiler at this step to avoid rebuilding the image. See <a class="xref" href="https://software.intel.com/content/www/us/en/secure/develop/documentation/intel-time-coordinated-computing-tools-vtune-0-11/top.html" target="_blank">Profiling Real-Time Applications with Intel® VTune™ Profiler</a>.</p>

                    </div>

                </li>

                <li class="li">
                    <p class="p">Set the BSP_YOCTO_FOLDER variable. For BSP directory, provide the
                    full path of the BSP working directory.</p>

                    <pre class="pre codeblock"><code>
export BSP_YOCTO_FOLDER=/&lt;BSP_directory&gt;/intel-embedded-system-enabling                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Remove non-compatible version of open62541 recipes from the BSP:</p>

                    <pre class="pre codeblock"><code>
rm -rf ${BSP_YOCTO_FOLDER}/meta-intel-embedded-system-enabling/meta-intel-ese-main/recipes-connectivity/open62541                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Make the integration shell script executable:</p>

                    <pre class="pre codeblock"><code>
chmod +x ./target/tcc_integrate_bsp.sh                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Run the following command to integrate Intel® TCC Tools into the BSP:</p>

                    <pre class="pre codeblock"><code>
./target/tcc_integrate_bsp.sh                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Go to the BSP directory:</p>

                    <pre class="pre codeblock"><code>
cd /&lt;BSP_directory&gt;/build                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Source the build environment. (Note: “.” is the current directory.)</p>

                    <pre class="pre codeblock"><code>
source ${BSP_YOCTO_FOLDER}/oe-init-build-env .                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Build the image.</p>

                    <pre class="pre codeblock"><code>
bitbake multiconfig:x86:core-image-sato-sdk                    </code></pre>
                </li>

                <li class="li">
                    <p class="p">Build the toolchain.</p>

                    <ol class="ol" type="a">
                        <li class="li">
                            <p class="p">Execute the following command to set the number of maximum open
                            file descriptors per user to 10240.</p>

                            <pre class="pre codeblock"><code>
ulimit -n 10240                            </code></pre>
                        </li>

                        <li class="li">
                            <p class="p">Build the toolchain:</p>

                            <pre class="pre codeblock"><code>
bitbake multiconfig:x86:core-image-sato-sdk -c populate_sdk                            </code></pre>
                        </li>

                    </ol>

                </li>

                <li class="li">
                    <p class="p">After the build is finished, confirm that you have the following items:</p>

                    <ul class="ul">
                        <li class="li">
                            <p class="p">Image:
                            <code class="ph codeph">&lt;BSP_directory&gt;/build/tmp-x86-glibc/deploy/images/intel-corei7-64/core-image-sato-sdk-intel-corei7-64-&lt;datetime&gt;.wic</code>.</p>

                        </li>

                        <li class="li">
                            <p class="p">Bmap file:
                            <code class="ph codeph">&lt;BSP_directory&gt;/build/tmp-x86-glibc/deploy/images/intel-corei7-64/core-image-sato-sdk-intel-corei7-64-&lt;datetime&gt;.wic.bmap</code>.</p>

                        </li>

                        <li class="li">
                            <p class="p">Toolchain installation script:
                            <code class="ph codeph">&lt;BSP_directory&gt;/build/tmp-x86-glibc/deploy/sdk/oecore-x86_64-corei7-64-toolchain-&lt;version&gt;.sh</code>.</p>

                        </li>

                    </ul>

                </li>

            </ol>

        </div>
    </div>

</body>
</html>